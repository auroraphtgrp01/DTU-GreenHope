/**
 * This file is part of the NocoBase (R) project.
 * Copyright (c) 2020-2024 NocoBase Co., Ltd.
 * Authors: NocoBase Team.
 *
 * This project is dual-licensed under AGPL-3.0 and NocoBase Commercial License.
 * For more information, please refer to: https://www.nocobase.com/agreement.
 */

(function(n,o){typeof exports=="object"&&typeof module!="undefined"?o(exports,require("@nocobase/client"),require("react"),require("@formily/react"),require("react/jsx-runtime"),require("@ant-design/icons"),require("antd")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react","@formily/react","react/jsx-runtime","@ant-design/icons","antd"],o):(n=typeof globalThis!="undefined"?globalThis:n||self,o(n["@dtu-olp-2024/progress-nocobase"]={},n["@nocobase/client"],n.react,n["@formily/react"],n.jsxRuntime,n["@ant-design/icons"],n.antd))})(this,function(n,o,s,g,p,x,S){"use strict";var H=Object.defineProperty,L=Object.defineProperties;var A=Object.getOwnPropertyDescriptors;var B=Object.getOwnPropertySymbols;var _=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable;var I=(n,o,s)=>o in n?H(n,o,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[o]=s,i=(n,o)=>{for(var s in o||(o={}))_.call(o,s)&&I(n,s,o[s]);if(B)for(var s of B(o))G.call(o,s)&&I(n,s,o[s]);return n},d=(n,o)=>L(n,A(o));var b=(n,o,s)=>new Promise((g,p)=>{var x=a=>{try{u(s.next(a))}catch(f){p(f)}},S=a=>{try{u(s.throw(a))}catch(f){p(f)}},u=a=>a.done?g(a.value):Promise.resolve(a.value).then(x,S);u((s=s.apply(n,o)).next())});const u="Progress",a=u.toLowerCase(),M={name:"@dtu-olp-2024/progress-nocobase",version:"1.0.0",license:"GPL-3.0",main:"dist/server/index.js",peerDependencies:{"@nocobase/client":"1.x","@nocobase/server":"1.x","@nocobase/test":"1.x"},publishConfig:{access:"public",registry:"https://registry.npmjs.org/"},repository:{type:"git",url:"git+https://github.com/olp-dtu-2024/DTU-GreenHope"}};function y(){const t=o.useApp();return e=>t.i18n.t(e,{ns:[M.name,"client"]})}const N={name:"height",type:"actionModal",useComponentProps(){var c,l;const t=g.useFieldSchema(),{deepMerge:e}=o.useDesignable(),r=y();return{title:r("Edit Height"),schema:{type:"object",title:r("Edit Height"),properties:{height:{title:r("Height"),type:"number",default:(l=(c=t["x-decorator-props"])==null?void 0:c[a])==null?void 0:l.height,"x-decorator":"FormItem","x-component":"InputNumber"}}},onSubmit({height:m}){var h;e({"x-uid":t["x-uid"],"x-decorator-props":d(i({},t["x-decorator-props"]),{[a]:d(i({},(h=t["x-decorator-props"])==null?void 0:h[a]),{height:m})})})}}}},P=new o.SchemaSettings({name:`blockSettings:${a}`,items:[{name:o.SchemaSettingsDataScope.name,Component:o.SchemaSettingsDataScope,useComponentProps:()=>{var m,h;const t=o.useCollection(),e=o.useAPIClient(),r=g.useFieldSchema(),c=((h=(m=r==null?void 0:r["x-decorator-props"])==null?void 0:m.params)==null?void 0:h.filter)||{},{deepMerge:l}=o.useDesignable();return{collectionName:t.name,defaultFilter:c,onSubmit:v=>b(this,null,function*(){const V={"x-uid":r["x-uid"],"x-decorator-props":d(i({},r["x-decorator-props"]),{params:{filter:i(i({},c),v.filter)}})};yield e.request({url:"/uiSchemas:patch",method:"POST",data:V}).then(z=>{z.status===200&&l({"x-decorator-props":d(i({},r["x-decorator-props"]),{params:{filter:i(i({},c),v.filter)}})})})})}}},{name:"editBlockTitle",Component:o.SchemaSettingsBlockTitleItem},{type:"remove",name:"remove",componentProps:{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}}},N]});function T(t){var l;const{filter:e,parseVariableLoading:r}=o.useParsedFilter({filterOption:(l=t.params)==null?void 0:l.filter});return{params:s.useMemo(()=>{var m;return d(i({},t.params),{appends:((m=t.params)==null?void 0:m.appends)||[],filter:e})},[JSON.stringify(e),t.params]),parseVariableLoading:r}}function j(t){const{params:e,parseVariableLoading:r}=T(t);let c;return t.association&&(c=o.useParentRecordCommon(t.association)),{params:e,parentRecord:c,parseVariableLoading:r}}function F(){var e,r;return(r=(e=g.useFieldSchema().parent)==null?void 0:e["x-decorator-props"])==null?void 0:r[a]}const w=({dataSource:t="main",collection:e})=>({type:"void","x-decorator":"DataBlockProvider","x-component":"CardItem","x-settings":P.name,"x-toolbar":"BlockSchemaToolbar","x-decorator-props":{[a]:{},rowKey:"id",runWhenParamsChanged:!0,readPretty:!0,dataSource:t,collection:e,action:"list"},"x-use-decorator-props":"useBlockScopeDecoratorProps",properties:{[a]:{type:"void","x-component":u,"x-use-component-props":"useProgressBlockProps"}}}),C={type:"item",name:a,Component:"DataBlockInitializer",icon:"PlayCircleOutlined",useComponentProps(){const{insert:t}=o.useSchemaInitializer();return{title:y()(u),icon:p.jsx(x.CodeOutlined,{}),componentType:u,useTranslationHooks:y,onCreateBlockSchema({item:r}){t(w({dataSource:r.dataSource,collection:r.name}))}}}};function k(t){return new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND",minimumFractionDigits:0,maximumFractionDigits:0}).format(t)}const q=()=>{const{data:t}=o.useDataBlockRequest();return{target:(t==null?void 0:t.data)&&(()=>{const e=(t==null?void 0:t.data)[0],r=(e==null?void 0:e.target_amount)||(e==null?void 0:e.targetAmount)||(e==null?void 0:e.target)||(e==null?void 0:e.targetBalance);return r>0?r:1})(),current:(t==null?void 0:t.data)&&(()=>{const e=(t==null?void 0:t.data)[0],r=(e==null?void 0:e.current_amount)||(e==null?void 0:e.currentAmount)||(e==null?void 0:e.current)||(e==null?void 0:e.currentBalance);return r>0?r:0})()}},O=o.withDynamicSchemaProps(()=>{const{target:t,current:e}=q(),r=s.useMemo(()=>{if(!t||t===0)return 0;const c=e/t*100;return Math.min(Math.max(0,Math.ceil(c)),100)},[t,e]);return p.jsx(S.Progress,{percent:r,format:()=>p.jsxs("div",{style:{position:"absolute",top:-24,left:0,right:0,display:"flex",justifyContent:"space-between",fontSize:"14px"},children:[p.jsx("b",{children:k(e)}),p.jsxs("b",{children:[r,"% cá»§a ",k(t)]})]}),strokeColor:"#20d043",trailColor:"#e0ece2",style:{overflow:"visible",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",position:"relative",height:12,borderRadius:6,marginTop:24}})});class D extends o.Plugin{load(){return b(this,null,function*(){this.app.addScopes({useBlockScopeDecoratorProps:j,useProgressBlockProps:F}),this.app.addComponents({Progress:O}),this.app.schemaSettingsManager.add(P),this.app.schemaInitializerManager.addItem("page:addBlock",`dataBlocks.${C.name}`,C)})}}n.ProgressNocobaseClient=D,n.default=D,Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
