/**
 * This file is part of the NocoBase (R) project.
 * Copyright (c) 2020-2024 NocoBase Co., Ltd.
 * Authors: NocoBase Team.
 *
 * This project is dual-licensed under AGPL-3.0 and NocoBase Commercial License.
 * For more information, please refer to: https://www.nocobase.com/agreement.
 */

(function(o,t){typeof exports=="object"&&typeof module!="undefined"?t(exports,require("@nocobase/client"),require("react"),require("@formily/react"),require("react/jsx-runtime"),require("antd"),require("@ant-design/icons")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react","@formily/react","react/jsx-runtime","antd","@ant-design/icons"],t):(o=typeof globalThis!="undefined"?globalThis:o||self,t(o["@dtu-olp-2024/carousel-nocobase"]={},o["@nocobase/client"],o.react,o["@formily/react"],o.jsxRuntime,o.antd,o["@ant-design/icons"]))})(this,function(o,t,n,p,f,x,P){"use strict";var U=Object.defineProperty,_=Object.defineProperties;var V=Object.getOwnPropertyDescriptors;var v=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable;var B=(o,t,n)=>t in o?U(o,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[t]=n,l=(o,t)=>{for(var n in t||(t={}))F.call(t,n)&&B(o,n,t[n]);if(v)for(var n of v(t))q.call(t,n)&&B(o,n,t[n]);return o},h=(o,t)=>_(o,V(t));var w=(o,t)=>{var n={};for(var p in o)F.call(o,p)&&t.indexOf(p)<0&&(n[p]=o[p]);if(o!=null&&v)for(var p of v(o))t.indexOf(p)<0&&q.call(o,p)&&(n[p]=o[p]);return n};var k=(o,t,n)=>new Promise((p,f)=>{var x=r=>{try{g(n.next(r))}catch(C){f(C)}},P=r=>{try{g(n.throw(r))}catch(C){f(C)}},g=r=>r.done?p(r.value):Promise.resolve(r.value).then(x,P);g((n=n.apply(o,t)).next())});const g="Carousel",r=g.toLowerCase(),A={name:"@dtu-olp-2024/carousel-nocobase",version:"1.0.1",license:"GPL-3.0",main:"dist/server/index.js",peerDependencies:{"@nocobase/client":"1.x","@nocobase/server":"1.x","@nocobase/test":"1.x"},files:["dist","dist/node_modules","README.md","LICENSE","package.json","server.js","server.d.ts","client.js","client.d.ts","CHANGELOG.md"],publishConfig:{access:"public",registry:"https://registry.npmjs.org/"},repository:{type:"git",url:"git+https://github.com/olp-dtu-2024/DTU-GreenHope"},displayName:"Carousel Plugin - DTU GreenHope 2024",description:"A NocoBase plugin for carousel view display. Built for the DTU GreenHope project.",keywords:["plugin","nocobase","dtu","greenhope","carousel"]};function y(){const e=t.useApp();return s=>e.i18n.t(s,{ns:[A.name,"client"]})}const M={name:"height",type:"actionModal",useComponentProps(){var c,u;const e=p.useFieldSchema(),{deepMerge:s}=t.useDesignable(),a=y();return{title:a("Edit Height"),schema:{type:"object",title:a("Edit Height"),properties:{height:{title:a("Height"),type:"number",default:(u=(c=e["x-decorator-props"])==null?void 0:c[r])==null?void 0:u.height,"x-decorator":"FormItem","x-component":"InputNumber"}}},onSubmit({height:d}){var i;s({"x-uid":e["x-uid"],"x-decorator-props":h(l({},e["x-decorator-props"]),{[r]:h(l({},(i=e["x-decorator-props"])==null?void 0:i[r]),{height:d})})})}}}},T={name:"objectFit",type:"select",useComponentProps(){var c,u;const e=p.useFieldSchema(),{deepMerge:s}=t.useDesignable();return{title:y()("Object Fit"),options:[{label:"Cover",value:"cover"},{label:"Contain",value:"contain"},{label:"Fill",value:"fill"},{label:"None",value:"none"},{label:"Scale Down",value:"scale-down"}],value:((u=(c=e["x-decorator-props"])==null?void 0:c[r])==null?void 0:u.objectFit)||"cover",onChange(d){var i;s({"x-uid":e["x-uid"],"x-decorator-props":h(l({},e["x-decorator-props"]),{[r]:h(l({},(i=e["x-decorator-props"])==null?void 0:i[r]),{objectFit:d})})})}}}},O={name:"autoplay",type:"switch",useComponentProps(){var c,u;const e=p.useFieldSchema(),{deepMerge:s}=t.useDesignable();return{title:y()("Autoplay"),checked:!!((u=(c=e["x-decorator-props"])==null?void 0:c[r])!=null&&u.autoplay),onChange(d){var i;s({"x-uid":e["x-uid"],"x-decorator-props":h(l({},e["x-decorator-props"]),{[r]:h(l({},(i=e["x-decorator-props"])==null?void 0:i[r]),{autoplay:d})})})}}}},I=new t.SchemaSettings({name:`blockSettings:${r}`,items:[{name:t.SchemaSettingsDataScope.name,Component:t.SchemaSettingsDataScope,useComponentProps:()=>{var d,i;const e=t.useCollection(),s=t.useAPIClient(),a=p.useFieldSchema(),c=((i=(d=a==null?void 0:a["x-decorator-props"])==null?void 0:d.params)==null?void 0:i.filter)||{},{deepMerge:u}=t.useDesignable();return{collectionName:e.name,defaultFilter:c,onSubmit:m=>k(this,null,function*(){const S={"x-uid":a["x-uid"],"x-decorator-props":h(l({},a["x-decorator-props"]),{params:{filter:l(l({},c),m.filter),appends:["images"]}})};yield s.request({url:"/uiSchemas:patch",method:"POST",data:S}).then(b=>{b.status===200&&u({"x-decorator-props":h(l({},a["x-decorator-props"]),{params:{filter:l(l({},c),m.filter),appends:["images"]}})})})})}}},{name:"editBlockTitle",Component:t.SchemaSettingsBlockTitleItem},{type:"remove",name:"remove",componentProps:{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}}},M,T,O]});function R(e){var d;const{filter:s,parseVariableLoading:a}=t.useParsedFilter({filterOption:(d=e.params)==null?void 0:d.filter}),c=n.useMemo(()=>{var b,N;const i=[],m=(b=e.fieldNames)==null?void 0:b.start,S=(N=e.fieldNames)==null?void 0:N.end;return Array.isArray(m)&&m.length>=2&&i.push(m[0]),Array.isArray(S)&&S.length>=2&&i.push(S[0]),i},[e.fieldNames]);return{params:n.useMemo(()=>{var i;return h(l({},e.params),{appends:[...c,...((i=e.params)==null?void 0:i.appends)||[],"images"],filter:s})},[c,JSON.stringify(s),e.params]),parseVariableLoading:a}}function z(e){const{params:s,parseVariableLoading:a}=R(e);let c;return e.association&&(c=t.useParentRecordCommon(e.association)),{params:s,parentRecord:c,parseVariableLoading:a}}function H(){var s,a;return(a=(s=p.useFieldSchema().parent)==null?void 0:s["x-decorator-props"])==null?void 0:a[r]}const E=({dataSource:e="main",collection:s})=>({type:"void","x-decorator":"DataBlockProvider","x-component":"FormItem","x-settings":I.name,"x-toolbar":"BlockSchemaToolbar","x-decorator-props":{[r]:{},rowKey:"id",runWhenParamsChanged:!0,readPretty:!0,dataSource:e,collection:s,action:"list"},"x-use-decorator-props":"useBlockScopeDecoratorProps",properties:{[r]:{type:"void","x-component":g,"x-use-component-props":"useCarouselBlockProps"}}}),G=()=>{const{data:e}=t.useDataBlockRequest();return{images:e?(e==null?void 0:e.data)[0].images:[]}},L=t.withDynamicSchemaProps(e=>{const{images:s}=G(),i=e,{data:a,height:c=300,objectFit:u="cover"}=i,d=w(i,["data","height","objectFit"]);return s&&s.length?f.jsx(x.Carousel,h(l({},d),{children:s.map(m=>f.jsx("div",{children:f.jsx("img",{src:m.url,alt:m.title,style:{height:c,width:"100%",objectFit:u}},m.title)},m.url))})):f.jsx(x.Result,{status:"404"})},{displayName:g}),D={type:"item",name:r,Component:"DataBlockInitializer",icon:"PlayCircleOutlined",useComponentProps(){const{insert:e}=t.useSchemaInitializer();return{title:y()(g),icon:f.jsx(P.CodeOutlined,{}),componentType:g,useTranslationHooks:y,onCreateBlockSchema({item:a}){e(E({dataSource:a.dataSource,collection:a.name}))}}}};class j extends t.Plugin{load(){return k(this,null,function*(){this.app.addScopes({useBlockScopeDecoratorProps:z,useCarouselBlockProps:H}),this.app.addComponents({Carousel:L}),this.app.schemaSettingsManager.add(I),this.app.schemaInitializerManager.addItem("page:addBlock",`dataBlocks.${D.name}`,D),this.app.schemaInitializerManager.addItem("table:configureActions","enableActions.customRequest",{type:"item",name:"customRequest",title:'{{t("Custom request")}}',Component:"CustomRequestInitializer"}),this.app.schemaInitializerManager.addItem("list:configureActions","enableActions.customRequest",{type:"item",name:"customRequest",title:'{{t("Custom request")}}',Component:"CustomRequestInitializer"})})}}o.CarouselNocobaseClient=j,o.default=j,Object.defineProperties(o,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
